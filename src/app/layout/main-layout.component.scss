@import '../styles/bootstrap-mixins';

// Main layout styles with proper space segregation
.main-layout {
  position: relative;
  min-height: 100vh;
  background-color: var(--bs-body-bg);
  color: var(--bs-body-color);
  z-index: 1;
  overflow-x: hidden;
  width: 100%;
  box-sizing: border-box;
  
  // Ensure proper layering during zoom
  @media screen and (min-resolution: 120dpi), 
         screen and (-webkit-min-device-pixel-ratio: 1.25) {
    z-index: 1;
  }
  
  @media screen and (min-resolution: 192dpi),
         screen and (-webkit-min-device-pixel-ratio: 2) {
    z-index: 1;
  }
}

// Header fixed at top
.main-header {
  width: 100%;
  height: 72px;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1100;
}

// New flex row for body below header
.layout-body {
  display: flex;
  flex-direction: row;
  width: 100%;
  min-height: calc(100vh - 72px); // header height
}

// Sidenav fixed below header
app-sidenav, .sidenav {
  position: fixed !important;
  top: 72px !important;
  left: 0;
  height: calc(100vh - 72px) !important;
  width: 280px !important;
  z-index: 1040;
}

// Content wrapper fills remaining space
.content-wrapper {
  margin-left: 280px;
  padding-top: 72px;
  width: calc(100% - 280px);
  min-height: calc(100vh - 72px);
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  position: relative;
  z-index: 1;
  transition: margin-left 0.3s ease, width 0.3s ease;
  
  // Default state - no sidenav, full width
  margin-left: 0;
  width: 100%;
  
  // When sidenav is present and not in overlay mode (desktop)
  &.with-sidenav {
    @include media-breakpoint-up(lg) {
      // Expanded state
      &.sidenav-expanded {
        margin-left: 280px;
        width: calc(100% - 280px);
        max-width: calc(100vw - 280px);
        transition: margin-left 0.3s ease, width 0.3s ease, max-width 0.3s ease;
      }
      
      // Collapsed state
      &.sidenav-collapsed {
        margin-left: 70px;
        width: calc(100% - 70px);
        max-width: calc(100vw - 70px);
        transition: margin-left 0.3s ease, width 0.3s ease, max-width 0.3s ease;
      }
    }
  }
  
  // Mobile/tablet responsive - overlay mode, full width
  @include media-breakpoint-down(lg) {
    margin-left: 0;
    width: 100%;
    
    // Add backdrop when sidenav is open on mobile
    &.with-sidenav {
      &::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: calc(var(--sidenav-z-index) - 1);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        pointer-events: none;
      }
      
      &.sidenav-overlay-active::before {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
    }
  }
}

// Remove header from content-wrapper
.main-header {
  width: 100%;
  height: 72px;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1100;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  width: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
  position: relative;
  z-index: 1;
  padding-top: 0;
  &.with-header {
    padding-top: 0;
    min-height: 100%;
  }
  &.with-footer {
    padding-bottom: 0;
  }
  
  // Ensure proper layering during zoom
  @media screen and (min-resolution: 120dpi), 
         screen and (-webkit-min-device-pixel-ratio: 1.25) {
    z-index: 1;
  }
  
  @media screen and (min-resolution: 192dpi),
         screen and (-webkit-min-device-pixel-ratio: 2) {
    z-index: 1;
  }
}

.main-footer {
  flex-shrink: 0;
  width: 100%;
}

// Responsive and zoom support
@media (max-width: 991.98px) {
  .layout-body {
    flex-direction: column;
  }
  app-sidenav, .sidenav {
    position: fixed !important;
    top: 72px !important;
    left: 0;
    width: 80vw !important;
    max-width: 320px;
    height: calc(100vh - 72px) !important;
    z-index: calc(var(--sidenav-z-index) + 10);
  }
  .content-wrapper {
    margin-left: 0;
    width: 100%;
    padding-top: 72px;
  }
  
  .navbar.with-sidenav-expanded,
  .navbar.with-sidenav-collapsed {
    left: 0;
    width: 100%;
  }
}

// Zoom level support - handle different zoom levels
@media screen and (min-resolution: 120dpi), 
       screen and (-webkit-min-device-pixel-ratio: 1.25) {
  .content-wrapper {
    &.with-sidenav {
      @include media-breakpoint-up(lg) {
        &.sidenav-expanded {
          // margin-left: 280px;
          // width: calc(100% - 280px);
          // max-width: calc(100vw - 280px); // Prevent overflow
          width: 100%;
        }
        
        &.sidenav-collapsed {
          margin-left: 70px;
          width: calc(100% - 70px);
          max-width: calc(100vw - 70px); // Prevent overflow
        }
      }
    }
  }
  
  .navbar {
    &.with-sidenav-expanded {
      @include media-breakpoint-up(lg) {
        left: 280px;
        width: calc(100% - 280px);
      }
    }
    
    &.with-sidenav-collapsed {
      @include media-breakpoint-up(lg) {
        left: 70px;
        width: calc(100% - 70px);
      }
    }
  }
}

// High zoom levels (150%+)
@media screen and (min-resolution: 192dpi),
       screen and (-webkit-min-device-pixel-ratio: 2) {
  .content-wrapper {
    &:not(.with-sidenav) {
      margin-left: 0;
      width: 100%;
      max-width: 100vw; // Prevent overflow
    }
    
    &.with-sidenav {
      @include media-breakpoint-up(lg) {
        &.sidenav-expanded {
          margin-left: 280px;
          width: calc(100% - 280px);
          max-width: calc(100vw - 280px); // Prevent overflow
        }
        
        &.sidenav-collapsed {
          margin-left: 70px;
          width: calc(100% - 70px);
          max-width: calc(100vw - 70px); // Prevent overflow
        }
      }
    }
  }
  
  .navbar {
    &:not(.with-sidenav-expanded):not(.with-sidenav-collapsed) {
      left: 0;
      width: 100%;
    }
  }
}

// Theme-specific adjustments
[data-bs-theme="dark"] {
  .main-layout {
    background-color: var(--bs-dark);
    color: var(--bs-light);
  }
}

// Mobile responsive adjustments
@include media-breakpoint-down(md) {
  .main-content {
    &.with-header {
      padding-top: 0; /* Smaller header on mobile */
      min-height: calc(100vh - 72px);
    }
  }
}

// Accessibility improvements
@media (prefers-reduced-motion: reduce) {
  .content-wrapper,
  .main-header {
    transition: none;
  }
}

// Print styles
@media print {
  .main-header,
  .main-footer {
    display: none;
  }
  
  .content-wrapper {
    margin-left: 0 !important;
    width: 100% !important;
  }
}

// Lower sidenav stacking only when a popup/modal is present in main content
// Covers our custom modal, search modal, and Bootstrap modals
.main-layout:has(.modal-popup-container),
.main-layout:has(.search-modal-overlay),
.main-layout:has(.modal.show) {
  app-sidenav,
  .sidenav {
    z-index: -1040 !important;
  }
}