<!-- API Dashboard -->
<div class="api-dashboard">
  <div class="container-fluid px-lg-4 px-md-3 px-2 py-4 pad30 Mmb-30">
    
    <!-- Error State -->
    <app-error-display 
      *ngIf="error"
      type="error"
      title="Failed to Load Dashboard"
      [message]="error"
      [showRetry]="true"
      retryText="Refresh Dashboard"
      (retry)="refreshDashboard()">
    </app-error-display>

    <!-- Dashboard Content -->
    <div *ngIf="!error">
      
      <!-- Welcome Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="welcome-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div class="flex-grow-1">
              <h1 class="display-6 fw-bold mb-0 text-body-emphasis">Welcome back {{userName}} ðŸ‘‹</h1>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-primary rounded-pill" 
                      (click)="refreshDashboard()"
                      [disabled]="loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <i *ngIf="!loading" class="bi bi-arrow-clockwise me-1"></i>
                {{ loading ? 'Loading...' : 'Refresh' }}
              </button>
              <button class="btn btn-primary rounded-pill" (click)="createApiKey()">
                <i class="bi bi-plus-lg me-1"></i>
                Create API Key
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards Row -->
      <div class="row g-3 mb-4" *ngIf="stats">
        
        <!-- Total API Calls Card -->
        <div class="col-lg-3 col-md-6 col-12">
          <div class="card border-0 shadow-sm stats-card bg-body">
            <div class="card-body p-3">
              <h6 class="text-body-secondary mb-1 fw-medium">Total API Calls (last 30 days)</h6>
              <h3 class="fw-bold mb-1 text-body-emphasis">{{ formatNumber(stats.apiCalls.current) }}</h3>
              <small class="text-success fw-medium">{{ stats.apiCalls.change || '+0%' }}</small>
            </div>
          </div>
        </div>

        <!-- Active Domains Card -->
        <div class="col-lg-3 col-md-6 col-12">
          <div class="card border-0 shadow-sm stats-card bg-body">
            <div class="card-body p-3">
              <h6 class="text-body-secondary mb-1 fw-medium">Active Domains (projects)</h6>
              <h3 class="fw-bold mb-1 text-body-emphasis">{{ getUniqueDomainCount() }}</h3>
              <small class="text-success fw-medium">{{ stats.activeProjects.change || '+0%' }}</small>
            </div>
          </div>
        </div>

        <!-- Domains Added Card -->
        <div class="col-lg-3 col-md-6 col-12">
          <div class="card border-0 shadow-sm stats-card bg-body">
            <div class="card-body p-3">
              <h6 class="text-body-secondary mb-1 fw-medium">Domains Added (this month)</h6>
              <h3 class="fw-bold mb-1 text-body-emphasis">{{ getDomainsAddedThisMonth() }}</h3>
              <small class="text-success fw-medium">{{ stats.brandsAdded.change || '+0%' }}</small>
            </div>
          </div>
        </div>

        <!-- Remaining Quota Card -->
        <div class="col-lg-3 col-md-6 col-12">
          <div class="card border-0 shadow-sm stats-card bg-body">
            <div class="card-body p-3">
              <h6 class="text-body-secondary mb-1 fw-medium">Remaining Quota</h6>
              <h3 class="fw-bold mb-1 text-body-emphasis">{{ formatNumber(stats.remainingQuota.current) }}</h3>
              <small class="text-success fw-medium">{{ (100 - stats.remainingQuota.percentage) }}% remaining</small>
            </div>
          </div>
        </div>

      </div>

      <!-- Quota Usage Section -->
      <div class="row mb-4" *ngIf="stats">
        <div class="col-12">
          <div class="card border-0 shadow-sm bg-body">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0 fw-bold">Quota Usage</h5>
                <span class="badge" 
                      [class.bg-success]="stats.remainingQuota.percentage <= 50"
                      [class.bg-warning]="stats.remainingQuota.percentage > 50 && stats.remainingQuota.percentage <= 80"
                      [class.bg-danger]="stats.remainingQuota.percentage > 80">
                  {{ stats.remainingQuota.percentage }}% used
                </span>
              </div>
              <div class="progress mb-2" style="height: 12px;">
                <div class="progress-bar" 
                     [class.bg-success]="stats.remainingQuota.percentage <= 50"
                     [class.bg-warning]="stats.remainingQuota.percentage > 50 && stats.remainingQuota.percentage <= 80"
                     [class.bg-danger]="stats.remainingQuota.percentage > 80"
                     role="progressbar" 
                     [style.width.%]="stats.remainingQuota.percentage"
                     [attr.aria-valuenow]="stats.remainingQuota.percentage"
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-body-secondary">{{ formatNumber(stats.remainingQuota.total -stats.remainingQuota.current) }} used / {{ formatNumber(stats.remainingQuota.total) }} total</small>
                <small class="text-body-secondary">{{ formatNumber(stats.remainingQuota.current) }} remaining</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Row -->
      <div class="row g-4">
        
        <!-- Recent API Keys Table Section -->
        <div class="col-lg-8 col-12">
          <div class="card border-0 shadow-sm bg-body">
            <div class="card-body p-0">
              <div class="d-flex justify-content-between align-items-center p-4 border-bottom">
                <h5 class="card-title mb-0 fw-bold">Recent API Keys</h5>
                <button class="btn btn-outline-primary btn-sm rounded-pill" (click)="viewAllApiKeys()">
                  <i class="bi bi-list-ul me-1"></i>
                  View All
                </button>
              </div>
              
              <!-- API Keys Table -->
              <div class="table-responsive">
                <table class="table table-hover mb-0 api-keys-thead-container">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th class="border-0 fw-semibold text-body-secondary">Domain Name</th>
                      <th class="border-0 fw-semibold text-body-secondary">Key Name</th>
                      <th class="border-0 fw-semibold text-body-secondary">Environment</th>
                      <th class="border-0 fw-semibold text-body-secondary" style="text-align: center;">Status</th>
                      <th class="border-0 fw-semibold text-body-secondary" style="text-align: center;">Last Used</th>
                    </tr>
                  </thead>
                </table>
                <div class="api-keys-tbody-container" 
                     [class.scrollable]="filteredApiKeys.length > 5">
                  <table class="table table-hover mb-0">
                    <tbody>
                      <tr *ngFor="let apiKey of filteredApiKeys; trackBy: trackByApiKeyId" 
                          class="cursor-pointer"
                          (click)="selectApiKey(apiKey)"
                          [class.table-active]="selectedApiKey?.id === apiKey.id">
                        <td class="py-3">
                          <div class="d-flex align-items-center">
                            <i class="bi bi-globe2 text-primary me-2"></i>
                            <span class="fw-medium text-body-emphasis">{{ getDomainFromApiKey(apiKey) }}</span>
                            <span *ngIf="apiKey.defaultKey" class="badge bg-primary text-white rounded-pill px-2 py-1 ms-2" style="font-size: 0.7rem;">
                              primary
                            </span>
                          </div>
                        </td>
                        <td class="py-3">
                          <div class="d-flex align-items-center">
                            <i class="bi bi-key text-warning me-2"></i>
                            <div>
                              <span class="fw-medium text-primary">{{ apiKey.name.length > 12 ? (apiKey.name | slice:0:12) + '...' : apiKey.name }}</span>
                              <br>
                              <small class="text-muted">{{ apiKey.maskedKey }}</small>
                            </div>
                          </div>
                        </td>
                        <td class="py-3">
                          <span class="badge" 
                                [class.bg-warning]="apiKey.environment === 'production'"
                                [class.bg-info]="apiKey.environment === 'development'"
                                [class.bg-secondary]="apiKey.environment === 'testing'"
                                [class.text-dark]="apiKey.environment !== 'production'">
                            {{ getEnvironmentDisplayName(apiKey.environment) }}
                          </span>
                        </td>
                        <td class="py-3">
                          <span [class]="getApiKeyStatusBadgeClass(apiKey.status)">
                            <i class="bi" 
                               [class.bi-check-circle]="apiKey.status === 'ACTIVE'"
                               [class.bi-pause-circle]="apiKey.status === 'SUSPENDED'"
                               [class.bi-x-circle]="apiKey.status === 'REVOKED'"
                               [class.bi-clock]="apiKey.status === 'EXPIRED'"
                               class="me-1"></i>
                            {{ getStatusDisplayName(apiKey.status) }}
                          </span>
                        </td>
                        <td class="py-3">
                          <div class="d-flex align-items-center">
                            <i class="bi bi-clock text-muted me-2"></i>
                            <span class="text-body-secondary">{{ formatDate(apiKey.usage.lastUsed || apiKey.createdAt) }}</span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="filteredApiKeys.length === 0" class="text-center py-5">
                <i class="bi bi-key display-1 text-body-secondary mb-3" style="opacity: 0.5;"></i>
                <h6 class="text-body-secondary">No API Keys Found</h6>
                <p class="text-body-secondary small mb-3">Create your first API key to get started</p>
                <button class="btn btn-primary btn-sm rounded-pill" (click)="createApiKey()">
                  <i class="bi bi-plus-lg me-1"></i>
                  Create API Key
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- API Key Details Sidebar -->
        <div class="col-lg-4 col-12">
          <div class="card border-0 shadow-sm bg-body" *ngIf="selectedApiKey">
            <div class="card-body p-4">
              <!-- API Key Header -->
              <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                  <div class="bg-warning bg-opacity-10 rounded-3 p-2 me-3">
                    <i class="bi bi-shield-lock text-warning fs-5"></i>
                  </div>
                  <div>
                    <h6 class="mb-0 fw-bold">{{ selectedApiKey.name }}</h6>
                    <small class="text-body-secondary">{{ getTierDisplayName(selectedApiKey.tier) }}</small>
                  </div>
                </div>
                <!-- <button class="btn btn-outline-primary btn-sm squared-pill" (click)="viewApiKeyFullDetails(selectedApiKey)">
                  View More
                </button> -->
              </div>

              <!-- Usage Stats -->
              <!-- <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-body-secondary">Usage</span>
                  <span class="fw-semibold">{{ formatNumber(selectedApiKey.usage.requestsToday || 0) }} / {{ formatNumber(13333) }}</span>
                </div>
                <div class="progress mb-2" style="height: 8px;">
                  <div class="progress-bar bg-primary" 
                       role="progressbar" 
                       [style.width.%]="getApiKeyUsagePercentage(selectedApiKey)"
                       [attr.aria-valuenow]="getApiKeyUsagePercentage(selectedApiKey)"
                       aria-valuemin="0" 
                       aria-valuemax="100">
                  </div>
                </div>
              </div> -->

              <!-- Details -->
              <div class="mb-4">
                <div class="row g-3">
                   <div class="col-6 mt-2">
                    <div class="text-body-secondary small">Domain</div>
                    <div class="fw-semibold d-flex align-items-center gap-2">
                      {{ getDomainFromApiKey(selectedApiKey) }}
                      <span *ngIf="selectedApiKey.defaultKey" class="badge bg-primary text-white rounded-pill px-2 py-1" style="font-size: 0.6rem;">
                        primary
                      </span>
                    </div>
                  </div>
                  <div class="col-6 mt-2">
                    <div class="text-body-secondary small">Key Name</div>
                    <div class="fw-semibold font-monospace small">{{ selectedApiKey.maskedKey }}</div>
                  </div>
                  <div class="col-6">
                    <div class="text-body-secondary small">Tier</div>
                    <div class="fw-semibold">{{ getTierDisplayName(selectedApiKey.tier) }}</div>
                  </div>
                  <div class="col-6">
                    <div class="text-body-secondary small">Expiry Date</div>
                    <div class="fw-semibold">{{ selectedApiKey.expiresAt ? formatDate(selectedApiKey.expiresAt) : 'Never' }}</div>
                  </div>                
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm squared-pill" (click)="viewApiKeyFullDetails(selectedApiKey)">
                   <i class="bi bi-eye"></i>
                  View
                </button>
                <button class="btn btn-outline-secondary btn-sm" (click)="editApiKey(selectedApiKey)">
                  Edit
                </button>
                <button class="btn btn-outline-danger btn-sm" 
                        (click)="showDeleteConfirmationDialog(selectedApiKey)"
                        [disabled]="deleting || (selectedApiKey.defaultKey === true)">
                  <span *ngIf="deleting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ deleting ? 'Deleting...' : 'Delete' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Placeholder when no API key selected -->
          <div class="card border-0 shadow-sm bg-body" *ngIf="!selectedApiKey && filteredApiKeys.length > 0">
            <div class="card-body p-4 text-center">
              <i class="bi bi-key display-1 text-body-secondary mb-3" style="opacity: 0.3;"></i>
              <h6 class="text-body-secondary">Select an API Key</h6>
              <p class="text-body-secondary small mb-0">Click on an API key from the table to view its details</p>
            </div>
          </div>
        </div>

      </div>

    </div>

  </div>
</div>

<!-- Edit API Key Modal -->
<app-edit-api-key
  [apiKey]="editingApiKey"
  [isVisible]="showEditModal"
  (onClose)="onEditModalClose()"
  (onSave)="onEditModalSave($event)">
</app-edit-api-key>