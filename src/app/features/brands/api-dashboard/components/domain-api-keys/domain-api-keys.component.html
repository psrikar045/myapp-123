<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2 text-body-secondary">Loading API keys...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="alert alert-danger" role="alert">
  <i class="bi bi-exclamation-triangle me-2"></i>
  {{ error }}
  <button class="btn btn-outline-danger btn-sm ms-3" (click)="ngOnInit()">
    <i class="bi bi-arrow-clockwise me-1"></i>
    Retry
  </button>
</div>

<!-- Main Content -->
<div *ngIf="!loading && !error && selectedApiKey" class="container-fluid px-lg-4 px-md-3 px-2 py-4">
  
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <!-- <div class="d-flex align-items-center">
          <button class="btn btn-outline-secondary me-3" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>Back
          </button>
          <div>
          </div>
        </div> -->
         <div class="d-flex align-items-center gap-3 hover-back-div cursor-pointer" (click)="goBack()">
                <i class="bi bi-arrow-left me-2"></i>
              <div>
                <h1 class="display-6 fw-bold mb-0 text-body-emphasis">
                  <span class="default-text">API Key Details</span>
                  <span class="hover-text">Back</span>
                </h1>
              </div>
            </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary squared-pill" 
                  (click)="refreshDashboard()"
                  [disabled]="dashboardLoading">
            <span *ngIf="dashboardLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!dashboardLoading" class="bi bi-arrow-clockwise me-1"></i>
            {{ dashboardLoading ? 'Refreshing...' : 'Refresh' }}
          </button>
          <button *ngIf="canShowFullKey(selectedApiKey)" 
                  class="btn squared-pill"
                  [class.btn-outline-success]="!isShowingFullKey(selectedApiKey)"
                  [class.btn-success]="isShowingFullKey(selectedApiKey)"
                  (click)="toggleShowFullKey(selectedApiKey)"
                  [disabled]="isDecryptingKey(selectedApiKey) || selectedApiKey.status === 'REVOKED'">
            <span *ngIf="isDecryptingKey(selectedApiKey)" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!isDecryptingKey(selectedApiKey)" 
               [class]="isShowingFullKey(selectedApiKey) ? 'bi bi-eye-slash me-1' : 'bi bi-eye me-1'"></i>
            {{ isDecryptingKey(selectedApiKey) ? 'Decrypting...' : (isShowingFullKey(selectedApiKey) ? 'Hide Key' : 'Show Key') }}
          </button>
          <button class="btn btn-outline-primary squared-pill"
          [disabled]="selectedApiKey.status === 'REVOKED'" (click)="copyApiKey(selectedApiKey)">
            <i class="bi bi-clipboard me-1"></i>
            Copy Key
          </button>
          <button class="btn btn-outline-danger squared-pill" 
                  (click)="showRevokeConfirmationDialog()"
                  [disabled]="revoking || selectedApiKey.status === 'REVOKED'">
            <span *ngIf="revoking" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!revoking" class="bi bi-x-circle me-1"></i>
            {{ revoking ? 'Revoking...' : 'Revoke' }}
          </button>
          <button class="btn btn-outline-warning squared-pill" 
                  (click)="regenerateApiKey(selectedApiKey)" 
                  [disabled]="regenerating || selectedApiKey.status === 'REVOKED'">
            <span *ngIf="regenerating" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!regenerating" class="bi bi-arrow-clockwise me-1"></i>
            {{ regenerating ? 'Regenerating...' : 'Regenerate Key' }}
          </button>
        </div>
         <!-- <div class="d-flex gap-2">
          <button class="btn btn-outline-warning squared-pill" 
                  (click)="regenerateApiKey(selectedApiKey)" 
                  [disabled]="regenerating">
            <span *ngIf="regenerating" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!regenerating" class="bi bi-arrow-clockwise me-1"></i>
            {{ regenerating ? 'Regenerating...' : 'Regenerate Key' }}
          </button>
        </div> -->
      </div>
      <p class="text-body-secondary mb-0">Detailed information about your API key and its configuration.</p>
    </div>
  </div>

  <!-- API Key Header Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm bg-body">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8 col-md-7 col-12">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                  <i class="bi bi-shield-lock text-primary fs-4"></i>
                </div>
                <div>
                  <h3 class="fw-bold mb-1 text-body-emphasis">{{ selectedApiKey.name }}</h3>
                  <p class="text-body-secondary mb-0">{{ getTierDisplayName(selectedApiKey.tier) }}  • Domain: {{ domain }}</p>
                </div>
              </div>
              <div class="d-flex flex-wrap gap-3">
                <span [class]="getStatusBadgeClass(selectedApiKey.status)">
                  {{ selectedApiKey.status }}
                </span>
                <span class="badge bg-light text-dark border">
                  {{ getEnvironmentDisplayName(selectedApiKey.environment || 'production') }}
                </span>
              </div>
            </div>
            <div class="col-lg-4 col-md-5 col-12 text-end">
              <div class="text-body-secondary small mb-1">Created</div>
              <div class="fw-semibold">{{ formatDate(selectedApiKey.createdAt) }}</div>
              <div class="text-body-secondary small mb-1 mt-2">Expires</div>
              <div class="fw-semibold">{{ selectedApiKey.expiresAt ? formatDate(selectedApiKey.expiresAt) : 'Never' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Usage Statistics -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm bg-body">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">Usage Statistics</h5>
          <div class="row g-4">
            <div class="col-lg-3 col-md-6 col-12">
              <div class="text-center">
                <div class="text-body-secondary small mb-1">Requests Today</div>
                <div class="h4 fw-bold text-primary mb-0">{{ formatNumber(getTodaysRequests()) }}</div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-12">
              <div class="text-center">
                <div class="text-body-secondary small mb-1">Remaining Today</div>
                <div class="h4 fw-bold text-success mb-0">{{ formatNumber(getRemainingToday()) }}</div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-12">
              <div class="text-center">
                <div class="text-body-secondary small mb-1">Daily Usage %</div>
                <div class="h4 fw-bold mb-0"
                     [class.text-success]="getUsagePercentage(selectedApiKey) <= 50"
                     [class.text-warning]="getUsagePercentage(selectedApiKey) > 50 && getUsagePercentage(selectedApiKey) <= 80"
                     [class.text-danger]="getUsagePercentage(selectedApiKey) > 80">
                  {{ getUsagePercentage(selectedApiKey) ? getUsagePercentage(selectedApiKey) : 0}}%
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-12">
              <div class="text-center">
                <div class="text-body-secondary small mb-1">Last Used</div>
                <div class="h6 fw-semibold mb-0">{{ formatDate(selectedApiKey.usage.lastUsed || selectedApiKey.createdAt) }}</div>
              </div>
            </div>
          </div>
          
          <!-- Daily Usage Progress Bar -->
          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-body-secondary small">Today's Usage Progress</span>
              <span class="text-body-secondary small">{{ getUsagePercentage(selectedApiKey) ? getUsagePercentage(selectedApiKey) : 0}}% used today</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar" 
                   [class.bg-success]="getUsagePercentage(selectedApiKey) <= 50"
                   [class.bg-warning]="getUsagePercentage(selectedApiKey) > 50 && getUsagePercentage(selectedApiKey) <= 80"
                   [class.bg-danger]="getUsagePercentage(selectedApiKey) > 80"
                   role="progressbar" 
                   [style.width.%]="getUsagePercentage(selectedApiKey)"
                   [attr.aria-valuenow]="getUsagePercentage(selectedApiKey)"
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-1">
              <small class="text-body-secondary">{{ formatNumber(getTodaysRequests()) }} used / {{ formatNumber(getDailyLimit()) }} daily limit</small>
              <small class="text-body-secondary">{{ formatNumber(getRemainingToday()) }} remaining today</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key Configuration -->
  <div class="row mb-4">
    <div class="col-lg-6 col-12 mb-4">
      <div class="card border-0 shadow-sm bg-body h-100">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">
            <i class="bi bi-gear me-2 text-primary"></i>
            Configuration
          </h5>
          <div class="row g-3">
            <div class="col-12">
              <div class="d-flex justify-content-between">
                <span class="text-body-secondary">API Key ID</span>
                <span class="fw-medium">{{ selectedApiKey.id }}</span>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-body-secondary">API Key</span>
                <div class="d-flex align-items-center gap-2">
                  <span class="fw-medium font-monospace text-break" 
                        [class.text-success]="isShowingFullKey(selectedApiKey)"
                        style="max-width: 200px; word-break: break-all;">
                    {{ getDisplayKey(selectedApiKey) }}
                  </span>
                  <div class="btn-group" role="group">
                    <button *ngIf="canShowFullKey(selectedApiKey)" 
                            class="btn btn-outline-secondary btn-sm"
                            [class.btn-success]="isShowingFullKey(selectedApiKey)"
                            (click)="toggleShowFullKey(selectedApiKey)"
                            [disabled]="isDecryptingKey(selectedApiKey) || selectedApiKey.status === 'REVOKED'"
                            [title]="isShowingFullKey(selectedApiKey) ? 'Hide full key' : 'Show full key'">
                      <span *ngIf="isDecryptingKey(selectedApiKey)" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                      <i *ngIf="!isDecryptingKey(selectedApiKey)" 
                         [class]="isShowingFullKey(selectedApiKey) ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm"
                     [disabled]="selectedApiKey.status === 'REVOKED'"
                            (click)="copyApiKey(selectedApiKey)"
                            title="Copy to clipboard">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between">
                <span class="text-body-secondary">Tier</span>
                <span class="fw-medium">{{ getTierDisplayName(selectedApiKey.tier) }}</span>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-body-secondary">Environment</span>
                <span [class]="getStatusBadgeClass(selectedApiKey.environment || 'production')">
                  {{ getEnvironmentDisplayName(selectedApiKey.environment || 'production') }}
                </span>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-body-secondary">Rate Limit Status</span>
                <span [class]="'badge bg-' + (selectedApiKey.usage.rateLimitStatus === 'OK' ? 'success' : selectedApiKey.usage.rateLimitStatus === 'WARNING' ? 'warning' : 'danger')">
                  {{ selectedApiKey.usage.rateLimitStatus || 'OK' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-12 mb-4">
      <div class="card border-0 shadow-sm bg-body h-100">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">
            <i class="bi bi-shield-check me-2 text-success"></i>
            Security Settings
          </h5>
          <div class="row g-3">
            <div class="col-12" *ngIf="selectedApiKey.security?.domainRestrictions?.enabled">
              <div class="mb-3">
                <span class="text-body-secondary d-block mb-2">Allowed Domains</span>
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let domain of selectedApiKey.security.domainRestrictions.allowedDomains" 
                        class="badge bg-light text-dark border">
                    {{ domain }}
                  </span>
                </div>
              </div>
            </div>
            <div class="col-12" *ngIf="selectedApiKey.security?.ipRestrictions?.enabled">
              <div class="mb-3">
                <span class="text-body-secondary d-block mb-2">IP Restrictions</span>
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let ip of selectedApiKey.security.ipRestrictions.whitelist" 
                        class="badge bg-light text-dark border font-monospace">
                    {{ ip }}
                  </span>
                </div>
              </div>
            </div>
            <div class="col-12" *ngIf="selectedApiKey.security?.allowedOrigins && selectedApiKey.security.allowedOrigins.length > 0">
              <div class="mb-3">
                <span class="text-body-secondary d-block mb-2">Allowed Origins</span>
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let origin of selectedApiKey.security.allowedOrigins" 
                        class="badge bg-light text-dark border">
                    {{ origin }}
                  </span>
                </div>
              </div>
            </div>
            <div class="col-12" *ngIf="!selectedApiKey.security?.domainRestrictions?.enabled && !selectedApiKey.security?.ipRestrictions?.enabled && (!selectedApiKey.security?.allowedOrigins || selectedApiKey.security.allowedOrigins.length === 0)">
              <div class="text-center py-3">
                <i class="bi bi-shield-x text-body-secondary mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                <p class="text-body-secondary small mb-0">No security restrictions configured</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scopes and Permissions -->
  <div class="row mb-4" *ngIf="selectedApiKey.scopes && selectedApiKey.scopes.length > 0">
    <div class="col-12">
      <div class="card border-0 shadow-sm bg-body">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">
            <i class="bi bi-key me-2 text-info"></i>
            Scopes & Permissions
          </h5>
          <div class="d-flex flex-wrap gap-2">
            <span *ngFor="let scope of selectedApiKey.scopes" 
                  class="badge bg-info bg-opacity-10 text-info border border-info">
              {{ scope }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Empty State -->
<div *ngIf="!loading && !error && !selectedApiKey" class="container-fluid px-lg-4 px-md-3 px-2 py-4">
  <div class="text-center py-5">
    <i class="bi bi-key display-1 text-body-secondary mb-3" style="opacity: 0.5;"></i>
    <h5 class="text-body-secondary">API Key Not Found</h5>
    <p class="text-body-secondary">The requested API key could not be found or may have been deleted.</p>
    <button class="btn btn-primary" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
    </button>
  </div>
</div>

<!-- Regenerate API Key Popup Modal -->
<div *ngIf="showRegeneratePopup" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle me-2"></i>
          API Key Regenerated Successfully
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeRegeneratePopup()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-warning border-0 mb-4">
          <div class="d-flex align-items-start">
            <i class="bi bi-exclamation-triangle-fill text-warning me-3 mt-1"></i>
            <div>
              <h6 class="alert-heading mb-2">⚠️ Important Security Notice</h6>
              <p class="mb-0">
                <strong>This is the only time you'll see the complete API key.</strong> 
                Make sure to copy and store it securely before closing this dialog. 
                The old API key has been immediately invalidated.
              </p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold text-body-emphasis">
            <i class="bi bi-key me-2 text-primary"></i>
            Your New API Key
          </label>
          <div class="input-group">
            <input type="text" 
                   class="form-control font-monospace bg-light" 
                   [value]="regeneratedApiKey" 
                   readonly
                   style="font-size: 0.9rem; letter-spacing: 0.5px;">
            <button class="btn btn-outline-primary" 
                    type="button" 
                    (click)="copyRegeneratedApiKey()"
                    title="Copy to clipboard">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            Click the copy button to copy the API key to your clipboard
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="card bg-light border-0">
              <div class="card-body p-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-shield-check text-success me-2"></i>
                  <div>
                    <div class="fw-semibold small">Status</div>
                    <div class="text-success small">Active & Ready</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light border-0">
              <div class="card-body p-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-clock text-info me-2"></i>
                  <div>
                    <div class="fw-semibold small">Generated</div>
                    <div class="text-body-secondary small">{{ getCurrentDate() }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-light rounded p-3 mb-3">
          <h6 class="fw-semibold mb-2">
            <i class="bi bi-list-check me-2 text-primary"></i>
            Next Steps
          </h6>
          <ul class="mb-0 small">
            <li>Copy the API key above and store it in a secure location</li>
            <li>Update your applications to use the new API key</li>
            <li>Test your integration to ensure everything works correctly</li>
            <li>The old API key is now invalid and cannot be used</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeRegeneratePopup()">
          <i class="bi bi-x-circle me-1"></i>
          Close
        </button>
        <button type="button" class="btn btn-primary" (click)="copyRegeneratedApiKey()">
          <i class="bi bi-clipboard me-1"></i>
          Copy API Key
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Revoke Confirmation Modal -->
<div class="modal fade" 
     [class.show]="showRevokeConfirmation" 
     [style.display]="showRevokeConfirmation ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog" 
     aria-labelledby="revokeConfirmationModalLabel" 
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold" id="revokeConfirmationModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Revoke API Key
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="hideRevokeConfirmationDialog()" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" *ngIf="selectedApiKey">
        <div class="text-center mb-4">
          <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
            <i class="bi bi-shield-x text-danger" style="font-size: 2rem;"></i>
          </div>
          <h6 class="fw-bold mb-2">Are you sure you want to revoke this API key?</h6>
          <p class="text-body-secondary mb-0">This action cannot be undone. The API key will be permanently disabled and all applications using it will lose access immediately.</p>
        </div>

        <div class="bg-light rounded p-3 mb-3">
          <div class="row g-2">
            <div class="col-4">
              <div class="text-body-secondary small">API Key Name</div>
              <div class="fw-semibold">{{ selectedApiKey.name }}</div>
            </div>
            <div class="col-4">
              <div class="text-body-secondary small">Environment</div>
              <div class="fw-semibold">{{ getEnvironmentDisplayName(selectedApiKey.environment || 'production') }}</div>
            </div>
            <div class="col-4">
              <div class="text-body-secondary small">Current Status</div>
              <span [class]="getStatusBadgeClass(selectedApiKey.status || 'ACTIVE')">
                {{ selectedApiKey.status || 'ACTIVE' }}
              </span>
            </div>
          </div>
        </div>

        <div class="alert alert-warning d-flex align-items-start" role="alert">
          <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
          <div>
            <strong>Warning:</strong> Once revoked, this API key cannot be restored. You will need to create a new API key if you want to restore access.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="hideRevokeConfirmationDialog()">
          <i class="bi bi-x-circle me-1"></i>
          Cancel
        </button>
        <button type="button" 
                class="btn btn-danger" 
                (click)="revokeApiKey(selectedApiKey!)"
                [disabled]="revoking">
          <span *ngIf="revoking" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <i *ngIf="!revoking" class="bi bi-shield-x me-1"></i>
          {{ revoking ? 'Revoking...' : 'Revoke API Key' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Revoke Modal Backdrop -->
<div class="modal-backdrop fade" 
     [class.show]="showRevokeConfirmation" 
     [style.display]="showRevokeConfirmation ? 'block' : 'none'"
     (click)="hideRevokeConfirmationDialog()">
</div>