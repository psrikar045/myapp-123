<!-- Create API Key Form -->
<div class="create-api-key-container">
  <div class="container-fluid px-lg-4 px-md-3 px-2 py-4">
    
    <!-- Header -->
    <div class="row mb-2">
      <div class="col-12">
        <div class="mb-4">
          <h1 class="h2 fw-bold mb-0 text-body-emphasis">Create API Key</h1>
        </div>
      </div>
    </div>

    <!-- Success State -->
    <div *ngIf="success && createdApiKey" class="row justify-content-center">
      <div class="col-lg-8 col-12">
        <div class="success-container">
          <div class="text-center mb-4">
            <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
            <h2 class="fw-bold text-body-emphasis mb-2">API Key Created Successfully!</h2>
            <p class="text-body-secondary lead">Your new API key has been generated and is ready to use.</p>
          </div>

          <!-- Security Notice -->
          <div class="alert alert-warning border-0 rounded-4 mb-4">
            <div class="d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-3 text-warning"></i>
              <div>
                <h6 class="alert-heading mb-2">Important Security Notice</h6>
                <p class="mb-0">
                  <strong>Copy this key immediately!</strong> For security reasons, this is the only time you'll be able to view the complete API key.
                </p>
              </div>
            </div>
          </div>

          <!-- API Key Display -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
              <h5 class="card-title mb-3">
                <i class="bi bi-key-fill me-2 text-primary"></i>
                Your API Key
              </h5>
              
              <div class="input-group mb-3">
                <input 
                  type="text" 
                  class="form-control form-control-lg font-monospace"
                  [value]="createdApiKey"
                  readonly>
                <button 
                  class="btn btn-primary"
                  type="button"
                  (click)="copyApiKey()">
                  <i class="bi bi-clipboard me-1"></i>
                  {{ copyButtonText }}
                </button>
              </div>

              <!-- Key Details -->
              <div class="row g-3">
                <div class="col-md-3">
                  <small class="text-body-secondary">Name</small>
                  <p class="mb-0 fw-semibold">{{ createdApiKey.name }}</p>
                </div>
                <div class="col-md-3">
                  <small class="text-body-secondary">Tier</small>
                  <p class="mb-0 fw-semibold">{{ createdApiKey.rateLimitTier }}</p>
                </div>
                <div class="col-md-3">
                  <small class="text-body-secondary">Status</small>
                  <span class="badge bg-success">{{ createdApiKey.isActive ? 'Active' : 'Inactive' }}</span>
                </div>
                <div class="col-md-3">
                  <small class="text-body-secondary">Expires</small>
                  <p class="mb-0 fw-semibold">{{ createdApiKey.expiresAt ? (createdApiKey.expiresAt | date:'mediumDate') : 'Never' }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-3 justify-content-center">
            <button 
              class="btn btn-primary btn-lg rounded-pill"
              (click)="goBackToAccountHub()">
              <i class="bi bi-house-door me-2"></i>
              Back to Dashboard
            </button>
            <button 
              class="btn btn-outline-secondary btn-lg rounded-pill"
              (click)="createAnother()">
              <i class="bi bi-plus-circle me-2"></i>
              Create Another
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form State -->
     <!-- justify-content-center -->
    <div *ngIf="!success" class="row ">
      <div class="col-lg-6 col-12">
        
        <!-- Error Display -->
        <div *ngIf="error" class="alert alert-danger border-0 rounded-3 mb-4">
          <div class="d-flex align-items-start">
            <i class="bi bi-exclamation-triangle-fill me-3 text-danger"></i>
            <div>
              <h6 class="alert-heading mb-2">Error Creating API Key</h6>
              <p class="mb-0">{{ error }}</p>
            </div>
          </div>
        </div>

        <!-- Form -->
        <form [formGroup]="createForm" (ngSubmit)="onSubmit()">
          
          <!-- Domain Field -->
          <div class="mb-3">
            <label for="domain" class="form-label fw-medium text-dark">Domain</label>
            <input 
              type="text" 
              class="form-control form-control-lg"
              id="domain"
              formControlName="domain"
              placeholder="Enter domain or select from dropdown"
              style="border: 1px solid #e0e0e0; border-radius: 8px;"
              [class.is-invalid]="hasFieldError('domain')">
            <div *ngIf="hasFieldError('domain')" class="invalid-feedback">
              {{ getFieldError('domain') }}
            </div>
          </div>

          <!-- API Key Name Field -->
          <div class="mb-3">
            <label for="name" class="form-label fw-medium text-dark">API Key Name</label>
            <input 
              type="text" 
              class="form-control form-control-lg"
              id="name"
              formControlName="name"
              placeholder="Enter a name for your API key"
              style="border: 1px solid #e0e0e0; border-radius: 8px;"
              [class.is-invalid]="hasFieldError('name')">
            <div *ngIf="hasFieldError('name')" class="invalid-feedback">
              {{ getFieldError('name') }}
            </div>
          </div>

          <!-- Description Field -->
          <div class="mb-3">
            <label for="description" class="form-label fw-medium text-dark">Description (Optional)</label>
            <textarea 
              class="form-control form-control-lg"
              id="description"
              formControlName="description"
              rows="4"
              placeholder="Describe the purpose of this API key"
              style="border: 1px solid #e0e0e0; border-radius: 8px; resize: vertical;"
              [class.is-invalid]="hasFieldError('description')">
            </textarea>
            <div *ngIf="hasFieldError('description')" class="invalid-feedback">
              {{ getFieldError('description') }}
            </div>
          </div>

          <!-- Prefix Field -->
          <div class="mb-3">
            <label for="prefix" class="form-label fw-medium text-dark">Prefix</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control form-control-lg"
                id="prefix"
                formControlName="prefix"
                placeholder="mk"
                style="border: 1px solid #e0e0e0; border-radius: 8px 0 0 8px;"
                [class.is-invalid]="hasFieldError('prefix')">
              <span class="input-group-text bg-light" style="border: 1px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0;">
                <i class="bi bi-pencil text-muted"></i>
              </span>
            </div>
            <div *ngIf="hasFieldError('prefix')" class="invalid-feedback">
              {{ getFieldError('prefix') }}
            </div>
          </div>

          <!-- Environment Field -->
          <div class="mb-3">
            <label for="environment" class="form-label fw-medium text-dark">Environment</label>
            <select 
              class="form-select form-select-lg"
              id="environment"
              formControlName="environment"
              style="border: 1px solid #e0e0e0; border-radius: 8px;"
              [class.is-invalid]="hasFieldError('environment')">
              <option value="">Select environment</option>
              <option value="development">Development</option>
              <option value="staging">Staging</option>
              <option value="production">Production</option>
            </select>
            <div *ngIf="hasFieldError('environment')" class="invalid-feedback">
              {{ getFieldError('environment') }}
            </div>
          </div>

          <!-- Expiration Date Field -->
          <div class="mb-4">
            <label for="expirationDate" class="form-label fw-medium text-dark">Expiration Date</label>
            <app-date-picker-popup
              [value]="createForm.get('expirationDate')?.value"
              [config]="datePickerConfig"
              (valueChange)="onExpirationDateChange($event)">
            </app-date-picker-popup>
          </div>

          <!-- Rate Limit Tier Section -->
          <div class="mb-4">
            <h5 class="fw-bold text-dark mb-3">Rate Limit Tier</h5>
            <div class="row g-3">
              <div class="col-6">
                <div 
                  class="tier-option p-3 border rounded-3 cursor-pointer"
                  [class.selected]="createForm.get('tier')?.value?.tier === 'FREE_TIER'"
                  (click)="selectRateLimitTier(rateLimitTiers[0])"
                  style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                  <div class="fw-medium text-dark">Free (100 requests/mon)</div>
                </div>
              </div>
              <div class="col-6">
                <div 
                  class="tier-option p-3 border rounded-3 cursor-pointer"
                  [class.selected]="createForm.get('tier')?.value?.tier === 'PRO_TIER'"
                  (click)="selectRateLimitTier(rateLimitTiers[1])"
                  style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                  <div class="fw-medium text-dark">Pro (1000 requests/mon)</div>
                </div>
              </div>
              <!-- <div class="col-6">
                <div 
                  class="tier-option p-3 border rounded-3 cursor-pointer"
                  [class.selected]="createForm.get('tier')?.value?.tier === 'PREMIUM'"
                  (click)="selectRateLimitTier(rateLimitTiers[2])"
                  style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                  <div class="fw-medium text-dark">Premium (100000 requests/day)</div>
                </div>
              </div> -->
              <div class="col-6">
                <div 
                  class="tier-option p-3 border rounded-3 cursor-pointer"
                  [class.selected]="createForm.get('tier')?.value?.tier === 'BUSINESS_TIER'"
                  (click)="selectRateLimitTier(rateLimitTiers[2])"
                  style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                  <div class="fw-medium text-dark">Business (Unlimited requests/mon)</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Permissions Section -->
          <div class="mb-4">
            <h5 class="fw-bold text-dark mb-3">Permissions</h5>
            
            <!-- Users Permission -->
            <div class="permission-group mb-3">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded-3 cursor-pointer" 
                   style="border: 1px solid #e0e0e0;"
                   (click)="togglePermissionGroup('users')">
                <span class="fw-medium text-dark">Users</span>
                <i class="bi bi-chevron-down text-muted" 
                   [class.rotate-180]="expandedGroups.has('users')"></i>
              </div>
              <div *ngIf="expandedGroups.has('users')" class="permission-options p-3 border-start border-end border-bottom rounded-bottom" style="border-color: #e0e0e0;">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="readUsers" (change)="toggleScope('READ_USERS')" [checked]="isScopeSelected('READ_USERS')">
                  <label class="form-check-label" for="readUsers">Read Users</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="writeUsers" (change)="toggleScope('WRITE_USERS')" [checked]="isScopeSelected('WRITE_USERS')">
                  <label class="form-check-label" for="writeUsers">Write Users</label>
                </div>
              </div>
            </div>

            <!-- Brands Permission -->
            <div class="permission-group mb-3">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded-3 cursor-pointer" 
                   style="border: 1px solid #e0e0e0;"
                   (click)="togglePermissionGroup('brands')">
                <span class="fw-medium text-dark">Brands</span>
                <i class="bi bi-chevron-down text-muted" 
                   [class.rotate-180]="expandedGroups.has('brands')"></i>
              </div>
              <div *ngIf="expandedGroups.has('brands')" class="permission-options p-3 border-start border-end border-bottom rounded-bottom" style="border-color: #e0e0e0;">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="readBrands" (change)="toggleScope('READ_BRANDS')" [checked]="isScopeSelected('READ_BRANDS')">
                  <label class="form-check-label" for="readBrands">Read Brands</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="writeBrands" (change)="toggleScope('WRITE_BRANDS')" [checked]="isScopeSelected('WRITE_BRANDS')">
                  <label class="form-check-label" for="writeBrands">Write Brands</label>
                </div>
              </div>
            </div>

            <!-- Categories Permission -->
            <div class="permission-group mb-3">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded-3 cursor-pointer" 
                   style="border: 1px solid #e0e0e0;"
                   (click)="togglePermissionGroup('categories')">
                <span class="fw-medium text-dark">Categories</span>
                <i class="bi bi-chevron-down text-muted" 
                   [class.rotate-180]="expandedGroups.has('categories')"></i>
              </div>
              <div *ngIf="expandedGroups.has('categories')" class="permission-options p-3 border-start border-end border-bottom rounded-bottom" style="border-color: #e0e0e0;">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="readCategories" (change)="toggleScope('READ_CATEGORIES')" [checked]="isScopeSelected('READ_CATEGORIES')">
                  <label class="form-check-label" for="readCategories">Read Categories</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="writeCategories" (change)="toggleScope('WRITE_CATEGORIES')" [checked]="isScopeSelected('WRITE_CATEGORIES')">
                  <label class="form-check-label" for="writeCategories">Write Categories</label>
                </div>
              </div>
            </div>

            <!-- API Keys Permission -->
            <div class="permission-group mb-4">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded-3 cursor-pointer" 
                   style="border: 1px solid #e0e0e0;"
                   (click)="togglePermissionGroup('apiKeys')">
                <span class="fw-medium text-dark">API Keys</span>
                <i class="bi bi-chevron-down text-muted" 
                   [class.rotate-180]="expandedGroups.has('apiKeys')"></i>
              </div>
              <div *ngIf="expandedGroups.has('apiKeys')" class="permission-options p-3 border-start border-end border-bottom rounded-bottom" style="border-color: #e0e0e0;">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="readApiKeys" (change)="toggleScope('READ_API_KEYS')" [checked]="isScopeSelected('READ_API_KEYS')">
                  <label class="form-check-label" for="readApiKeys">Read API Keys</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="manageApiKeys" (change)="toggleScope('MANAGE_API_KEYS')" [checked]="isScopeSelected('MANAGE_API_KEYS')">
                  <label class="form-check-label" for="manageApiKeys">Manage API Keys</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-3 justify-content-end">
            <button 
              type="button" 
              class="btn btn-outline-secondary btn-lg px-4"
              (click)="goBack()"
              [disabled]="loading"
              style="border-radius: 8px;">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-primary btn-lg px-4"
              [disabled]="loading || createForm.invalid"
              style="border-radius: 8px; background-color: #007bff;">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              Create Key
            </button>
          </div>

        </form>
      </div>
    </div>

  </div>
</div>