<!-- Enhanced API Key Management -->
<div class="api-key-management">
  <div class="container-fluid px-xxl-5 px-xl-4 px-lg-3 px-md-2 px-1 py-4">
    
    <!-- Enhanced Header with Breadcrumb -->
    <div class="row mb-4">
      <div class="col-12">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a href="#" class="text-decoration-none" (click)="goBack()">
                <i class="bi bi-house-door me-1"></i>
                Account Hub
              </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">API Keys</li>
          </ol>
        </nav>
        
        <!-- Header Content -->
        <div class="header-content">
          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
            <div class="header-info">
              <div class="d-flex align-items-center mb-2">
                <button 
                  class="btn btn-outline-secondary rounded-pill me-3 d-flex align-items-center" 
                  (click)="goBack()"
                  [disabled]="loading">
                  <i class="bi bi-arrow-left me-1"></i>
                  <span class="d-none d-sm-inline">Back</span>
                </button>
                <div>
                  <h1 class="h2 fw-bold mb-1 text-body-emphasis d-flex align-items-center">
                    <i class="bi bi-key-fill me-2 text-primary"></i>
                    API Key Management
                  </h1>
                  <p class="text-body-secondary mb-0 small">Manage your API keys, monitor usage, and control access</p>
                </div>
              </div>
              
              <!-- Stats Summary -->
              <div class="stats-summary d-none d-md-flex align-items-center gap-4 mt-2">
                <div class="stat-item">
                  <span class="stat-value text-primary fw-bold">{{ apiKeys.length }}</span>
                  <span class="stat-label text-body-secondary small">Total Keys</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value text-success fw-bold">{{ getActiveKeysCount() }}</span>
                  <span class="stat-label text-body-secondary small">Active</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value text-warning fw-bold">{{ getExpiringKeysCount() }}</span>
                  <span class="stat-label text-body-secondary small">Expiring Soon</span>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="header-actions">
              <div class="d-flex flex-column flex-sm-row gap-2 align-items-stretch align-items-sm-center">
                <button 
                  class="btn btn-outline-primary rounded-pill d-flex align-items-center justify-content-center" 
                  (click)="refreshApiKeys()"
                  [disabled]="loading"
                  title="Refresh API keys list">
                  <i class="bi bi-arrow-clockwise me-1" [class.spin]="loading"></i>
                  <span class="d-none d-sm-inline">Refresh</span>
                </button>
                
                <div class="dropdown">
                  <button 
                    class="btn btn-outline-secondary rounded-pill dropdown-toggle d-flex align-items-center" 
                    type="button" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false">
                    <i class="bi bi-funnel me-1"></i>
                    <span class="d-none d-sm-inline">Filter</span>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" (click)="filterKeys('all')">All Keys</a></li>
                    <li><a class="dropdown-item" href="#" (click)="filterKeys('active')">Active Only</a></li>
                    <li><a class="dropdown-item" href="#" (click)="filterKeys('expired')">Expired</a></li>
                    <li><a class="dropdown-item" href="#" (click)="filterKeys('expiring')">Expiring Soon</a></li>
                  </ul>
                </div>
                
                <button 
                  class="btn btn-primary rounded-pill d-flex align-items-center justify-content-center" 
                  (click)="createApiKey()"
                  [disabled]="loading">
                  <i class="bi bi-plus-lg me-1"></i>
                  <span>Create API Key</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-body-secondary fs-5">Loading your API keys...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="alert alert-danger border-0 shadow-sm" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ error }}
      <button class="btn btn-outline-danger btn-sm ms-3 rounded-pill" (click)="refreshApiKeys()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        Retry
      </button>
    </div>

    <!-- Content -->
    <div *ngIf="!loading && !error">
      
      <!-- Bulk Actions -->
      <div *ngIf="getSelectedCount() > 0" class="row mb-3">
        <div class="col-12">
          <div class="alert alert-info border-0 d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-info-circle me-2"></i>
              {{ getSelectedCount() }} API key(s) selected
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-danger" (click)="deleteSelectedKeys()">
                <i class="bi bi-trash me-1"></i>
                Delete Selected
              </button>
              <button class="btn btn-outline-secondary" (click)="clearSelection()">
                Clear Selection
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- API Keys List -->
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow-sm bg-body">
            <div class="card-header bg-body border-0 py-3">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 fw-bold text-body-emphasis">Your API Keys ({{ apiKeys.length }})</h5>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" (click)="selectAllKeys()">
                    <i class="bi bi-check-all me-1"></i>
                    Select All
                  </button>
                  <button class="btn btn-outline-secondary" (click)="clearSelection()">
                    <i class="bi bi-x me-1"></i>
                    Clear
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              
              <!-- Desktop Table View -->
              <div class="table-responsive d-none d-lg-block">
                <table class="table table-hover mb-0">
                  <thead class="table-secondary">
                    <tr>
                      <th class="border-0 ps-4">
                        <input class="form-check-input" type="checkbox" 
                               [checked]="getSelectedCount() === apiKeys.length && apiKeys.length > 0"
                               (change)="getSelectedCount() === apiKeys.length ? clearSelection() : selectAllKeys()">
                      </th>
                      <th class="border-0 text-body-secondary fw-semibold text-uppercase small">Name</th>
                      <th class="border-0 text-body-secondary fw-semibold text-uppercase small">Status</th>
                      <th class="border-0 text-body-secondary fw-semibold text-uppercase small">Tier</th>
                      <th class="border-0 text-body-secondary fw-semibold text-uppercase small">Usage</th>
                      <th class="border-0 text-body-secondary fw-semibold text-uppercase small">Last Used</th>
                      <th class="border-0 pe-4 text-body-secondary fw-semibold text-uppercase small">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let apiKey of apiKeys; trackBy: trackByApiKeyId" 
                        class="border-0"
                        [class.table-active]="isKeySelected(apiKey.id)">
                      <td class="ps-4 py-3 border-0">
                        <input class="form-check-input" type="checkbox" 
                               [checked]="isKeySelected(apiKey.id)"
                               (change)="toggleKeySelection(apiKey.id)">
                      </td>
                      <td class="py-3 border-0">
                        <div>
                          <h6 class="mb-1 fw-semibold text-body-emphasis">{{ apiKey.name }}</h6>
                          <code class="small text-body-secondary bg-transparent p-0">{{ apiKey.maskedKey }}</code>
                          <button class="btn btn-link btn-sm p-0 ms-2" (click)="copyApiKey(apiKey.maskedKey)">
                            <i class="bi bi-clipboard text-body-secondary"></i>
                          </button>
                        </div>
                      </td>
                      <td class="py-3 border-0">
                        <span [class]="getStatusBadgeClass(apiKey.status)">
                          {{ apiKey.status }}
                        </span>
                        <div *ngIf="isExpiringSoon(apiKey)" class="mt-1">
                          <small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Expires soon
                          </small>
                        </div>
                      </td>
                      <td class="py-3 border-0">
                        <span class="badge bg-secondary rounded-pill">{{ apiKey.tier }}</span>
                      </td>
                      <td class="py-3 border-0">
                        <div class="d-flex align-items-center gap-2" style="min-width: 150px;">
                          <div class="flex-grow-1">
                            <div class="progress" style="height: 6px;">
                              <div class="progress-bar {{ getUsageProgressClass(getUsagePercentage(apiKey)) }} rounded-pill" 
                                   role="progressbar" 
                                   [style.width.%]="getUsagePercentage(apiKey)">
                              </div>
                            </div>
                          </div>
                          <small class="text-body-secondary text-nowrap">
                            {{ formatNumber(apiKey.usage.requestsToday) }}/{{ formatNumber(apiKey.usage.requestsToday + apiKey.usage.remainingToday) }}
                          </small>
                        </div>
                        <span [class]="getRateLimitBadgeClass(apiKey.usage.rateLimitStatus)" class="small mt-1">
                          {{ apiKey.usage.rateLimitStatus }}
                        </span>
                      </td>
                      <td class="py-3 border-0">
                        <span class="text-body-secondary">{{ formatDate(apiKey.usage.lastUsed) }}</span>
                      </td>
                      <td class="pe-4 py-3 border-0">
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary rounded-pill me-1" title="View Details">
                            <i class="bi bi-eye"></i>
                          </button>
                          <button class="btn btn-outline-secondary rounded-pill me-1" title="Edit">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-outline-danger rounded-pill" 
                                  (click)="confirmDelete(apiKey)" 
                                  title="Delete">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Mobile Card View -->
              <div class="d-lg-none">
                <div *ngFor="let apiKey of apiKeys; trackBy: trackByApiKeyId" 
                     class="api-key-card p-3 border-bottom"
                     [class.selected]="isKeySelected(apiKey.id)">
                  
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" 
                             [checked]="isKeySelected(apiKey.id)"
                             (change)="toggleKeySelection(apiKey.id)">
                      <label class="form-check-label">
                        <h6 class="mb-1 fw-semibold text-body-emphasis">{{ apiKey.name }}</h6>
                      </label>
                    </div>
                    <span [class]="getStatusBadgeClass(apiKey.status)">
                      {{ apiKey.status }}
                    </span>
                  </div>

                  <div class="mb-2">
                    <code class="small text-body-secondary bg-transparent p-0">{{ apiKey.maskedKey }}</code>
                    <button class="btn btn-link btn-sm p-0 ms-2" (click)="copyApiKey(apiKey.maskedKey)">
                      <i class="bi bi-clipboard text-body-secondary"></i>
                    </button>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-6">
                      <small class="text-body-secondary d-block">Tier</small>
                      <span class="badge bg-secondary rounded-pill">{{ apiKey.tier }}</span>
                    </div>
                    <div class="col-6">
                      <small class="text-body-secondary d-block">Last Used</small>
                      <span class="small text-body-emphasis">{{ formatDate(apiKey.usage.lastUsed) }}</span>
                    </div>
                  </div>

                  <div class="mb-3">
                    <small class="text-body-secondary d-block mb-1">Usage</small>
                    <div class="progress mb-1" style="height: 6px;">
                      <div class="progress-bar {{ getUsageProgressClass(getUsagePercentage(apiKey)) }} rounded-pill" 
                           role="progressbar" 
                           [style.width.%]="getUsagePercentage(apiKey)">
                      </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-body-secondary">
                        {{ formatNumber(apiKey.usage.requestsToday) }}/{{ formatNumber(apiKey.usage.requestsToday + apiKey.usage.remainingToday) }}
                      </small>
                      <span [class]="getRateLimitBadgeClass(apiKey.usage.rateLimitStatus)" class="small">
                        {{ apiKey.usage.rateLimitStatus }}
                      </span>
                    </div>
                  </div>

                  <div *ngIf="isExpiringSoon(apiKey)" class="alert alert-warning border-0 py-2 px-3 mb-3">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <small>This API key expires soon</small>
                  </div>

                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm rounded-pill flex-fill">
                      <i class="bi bi-eye me-1"></i>
                      View
                    </button>
                    <button class="btn btn-outline-secondary btn-sm rounded-pill flex-fill">
                      <i class="bi bi-pencil me-1"></i>
                      Edit
                    </button>
                    <button class="btn btn-outline-danger btn-sm rounded-pill" 
                            (click)="confirmDelete(apiKey)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div *ngIf="apiKeys.length === 0" class="text-center py-5">
                <i class="bi bi-key display-1 text-body-secondary mb-3" style="opacity: 0.5;"></i>
                <h5 class="text-body-secondary">No API Keys Found</h5>
                <p class="text-body-secondary">Create your first API key to get started with the API</p>
                <button class="btn btn-primary rounded-pill" (click)="createApiKey()">
                  <i class="bi bi-plus-lg me-1"></i>
                  Create Your First API Key
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirm" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold text-body-emphasis">Confirm Deletion</h5>
        <button type="button" class="btn-close" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="bi bi-exclamation-triangle text-warning display-4 mb-3"></i>
          <h6 class="text-body-emphasis">Are you sure you want to delete this API key?</h6>
          <p class="text-body-secondary mb-0">
            <strong>{{ keyToDelete?.name }}</strong><br>
            This action cannot be undone and will immediately revoke access.
          </p>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary rounded-pill" (click)="cancelDelete()">
          Cancel
        </button>
        <button type="button" class="btn btn-danger rounded-pill" (click)="deleteApiKey()">
          <i class="bi bi-trash me-1"></i>
          Delete API Key
        </button>
      </div>
    </div>
  </div>
</div>